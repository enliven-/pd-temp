<link rel="import" href="/components/polymer/polymer.html">
<link rel="import" href="/components/paper-input/paper-input.html">
<link rel="import" href="/components/paper-slider/paper-slider.html">

<link rel="import" href="/components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/components/font-roboto/roboto.html">
<link rel="import" href="/custom/classifieds-service/classifieds-service.html">

<link rel="import" href="/custom/classified-card/classified-card.html">

<polymer-element name="classified-form" constructor="ClassifiedForm" attributes="serializedFormData">
  <template>
    <style>
      #classified-form /deep/ input{
        width: 20em;
      }
      #classified-form paper-input /deep/ input[is=core-input] {
        font-family: 'RobotoDraft', sans-serif;
      }
      paper-input /deep/ .focused-underline {
        height: 1px;
      }
      paper-icon-button#clear {
        height: 24px;
        display: inline;
      }
      .hidden {
        display: none;
      }
      img {
        width : 120px;
        height: 140px;
      }

      ul.list {
        list-style  : none;
        padding     : 5px;
        margin      : 0px;
      }
      ul.list li {
        padding-bottom: 10px;
        background-color: white;
        border: 1px solid #eee;
      }
      .blue {
        background: #00BCD4;
      }
      
      .green {
        background: #4CAF50;
      }
      .red {
        background-color: #cb202d;
      }
      paper-button[raised] {
        color: #fff;
        font-family: RobotoDraft, 'Helvetica Neue', Helvetica, Arial;
        float: right;
      }

      .actions {
        margin-top: 10px;
        margin-bottom: 10px;
      }

      .flex-text {
        font-size : 10px;
      }
      @media (min-width: 600px) {
        .flex-text {
          font-size: 16px;
        }
      }
    </style>
 
    <div id="classified-form" layout vertical center>
      <classifieds-service id="service" url="/api/classifieds.json" classifieds="{{ classifieds }}"></classifieds-service>
      <paper-input floatinglabel id="title" label="Title" name="title" on-keyup="{{ keyup }}" value="{{ search }}"></paper-input>
      <paper-icon-button id="clear" on-click="{{ clearfn }}" icon="clear" role="button"></paper-icon-button>
      <template if="{{results.length > 0}}">
        <ul class="list hide">
          <template repeat="{{result in results}}">
            <li on-click="{{ selectfn }}">{{result}}</li>
          </template>
        </ul>
      </template>
      <!-- <img class="hide hidden" src="/fixtures/book1.jpg"> -->

      <div  id="quality" class="hide hidden">
        <span>Quality</span>
      </div>
      <paper-slider class="hide hidden" id="quality-slider" snaps="" min="0" max="2" step="1" value="0" role="slider" tabindex="0" aria-valuemin="0" aria-valuemax="2" aria-valuenow="1" on-core-change="{{ updateQuality }}"></paper-slider>

      <div  id="markings" class="hide hidden">
        <span>Markings</span>
      </div>
      <paper-slider class="hide hidden" id="markings-slider" snaps="" min="0" max="2" step="1" value="0" role="slider" tabindex="0" aria-valuemin="0" aria-valuemax="2" aria-valuenow="1" on-core-change="{{ updateMarkings }}"></paper-slider>

      <paper-input floatinglabel label="MRP"   class="hide hidden" id="mrp" name="mrp"></paper-input>
      <paper-input floatinglabel label="Price" class="hide hidden" id="price" name="price"></paper-input>


    </div>


    <div class="preview hide hidden"><span>Listing Preview:</span> <br>
      <classified-card id="classified-card" class="hide hidden">
        <span class="listing-img" id="listing-img"><img src="/fixtures/book1.jpg"></span>
        <span class="listing-title"           id="listing-title">{{ classified.title }}</span>
        <span class="listing-authors"         id="listing-authors">{{ classified.authors }}</span>
        <span class="listing-publication"     id="listing-publication">{{ classified.publication }}</span>
        <span class="listing-price"           id="listing-price">{{ classified.price }}</span>
      </classified-card>

      <div class="actions hidden hide">
        <paper-button raised="" class="colored blue flex-text" id="create"  role="button" tabindex="0">Create</paper-button>
        <paper-button raised="" class="colored red  flex-text" id="cancel"  role="button" tabindex="0">Cancel</paper-button>
      </div>
    </div>


  </template>

  <script>
    Polymer('classified-form', {
      create        : function() {
                      },
      ready         : function() {
                      },

      keyup         : function(e) {
                        this.updateResults();
                      },

      selectfn      : function(e) {
                        var $el = $(e.target);
                        if ($el.is("li")) {
                          var title   = $el.text();
                          var classified    = $.grep(this.classifieds, function(el) { return el.title === title; })[0];
                          $el.parent().html("");
                          this.populateForm(classified);
                          $('classified-form /deep/ div.footer').remove();
                        }
                      },

      clearfn       : function(e) {
                        $('classified-form /deep/ .hide').addClass('hidden');
                        $('classified-form /deep/ paper-input#title').attr("disabled", false);
                        $('classified-form /deep/ #title').val('');
                      },

      updateQuality : function(e) {
                        var quality;
                        var val = $('classified-form /deep/ #quality-slider').attr("aria-valuenow");
                        if (val==="0") {
                          quality = "Like New";
                        } else if (val==="1") {
                          quality = "Fair";
                        } else if (val==="2") {
                          quality = "Heavily Used";
                        }
                        $('classified-form /deep/ #quality > span').html(quality);
                        // $('classified-form /deep/ .ring').removeClass('ring');
                      },

      updateMarkings : function(e) {
                        var markings;
                        var val = $('classified-form /deep/ #markings-slider').attr("aria-valuenow");
                        if (val==="0") {
                          markings = "No Markings";
                        } else if (val==="1") {
                          markings = "Few Markings";
                        } else if (val==="2") {
                          markings = "Heavily Marked";
                        }
                        $('classified-form /deep/ #markings > span').html(markings);
                        // $('classified-form /deep/ .ring').removeClass('ring');
                      },

      updateResults : function() {
                        var search    = this.search;
                        var length    = search.trim().length;
                        this.results  = [];
                        var title;
                        if (length < 5) { return; }
                        for (var i = 0; i < this.classifieds.length; i++) {
                          title = this.classifieds[i].title;
                          if (title.toLowerCase().indexOf(search) > -1) { this.results.push(title); }
                        }
                        return;        
                      },
      populateForm  : function(classified) {
                        $('classified-form /deep/ .hide').removeClass('hidden');
                        $('classified-form /deep/ .list').addClass('hidden');
                        // $('classified-form /deep/ paper-input').attr("disabled", true);
                        $('classified-form /deep/ .floated-label').removeAttr("invisible");

                        $('#title /deep/ input').val(classified.title);
                        $('#author /deep/ input').val(classified.authors);
                        $('#department /deep/ input').val(classified.department);
                        $('#subject /deep/ input').val(classified.subject);
                        $('#publication /deep/ input').val(classified.publication);
                        // $('#price /deep/ input').val(classified.price);

                        $('classified-form /deep/ .hide').removeClass('hidden');
                        $('classified-form /deep/ #listing-title').html(classified.title);
                        $('classified-form /deep/ #listing-authors').html(classified.authors);
                        $('classified-form /deep/ #listing-publication').html(classified.publication);
                      },
      serializedFormData: function() {
                            var price    = $('#price /deep/ input').val();
                            var markings = 'no markings';
                            var quality  = 'like new'
                            var listing = {
                                            book_id           : 2,
                                            price             : 400,
                                            user_attributes   : { name : 'Viksit Arora', mobile : '9156420350', college_id : 1},
                                            quality           : quality,
                                            markings          : markings,
                                            college_id        : 1
                                          }
                            return listing;
                          }
    });
  </script>
</polymer-element>
